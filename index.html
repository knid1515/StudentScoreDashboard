<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดสรุปคะแนนนักเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
        }

        .chart-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .kpi-card {
             background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border-left: 5px solid transparent;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .kpi-card.students { border-color: #3b82f6; }
        .kpi-card.avg-score { border-color: #f59e0b; }
        .kpi-card.characters { border-color: #10b981; }
        .kpi-card.classes { border-color: #8b5cf6; }
    </style>
</head>

<body class="p-4 md:p-8">

    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
             <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            <p class="mt-4 text-lg text-gray-700">กำลังโหลดข้อมูลและสร้างกราฟ...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center space-x-4">
                <div class="bg-blue-600 p-3 rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">แดชบอร์ดสรุปคะแนนนักเรียน</h1>
                    <p class="text-gray-500">ภาพรวมข้อมูลคะแนน, ตัวละคร และอันดับนักเรียน</p>
                </div>
            </div>
        </header>
        
        <!-- Navbar -->
        <nav class="mb-8 bg-white p-2 rounded-lg shadow-md">
            <div id="class-filter-nav" class="flex flex-wrap items-center gap-2">
                <!-- Filter buttons will be inserted here by JavaScript -->
            </div>
        </nav>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Students -->
            <div class="kpi-card students flex items-center">
                <div class="bg-blue-100 p-4 rounded-full">
                   <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <div class="ml-4">
                    <p class="text-gray-500">นักเรียนทั้งหมด</p>
                    <p id="total-students" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>
            <!-- Average Score -->
            <div class="kpi-card avg-score flex items-center">
                <div class="bg-yellow-100 p-4 rounded-full">
                    <svg class="h-8 w-8 text-yellow-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                </div>
                <div class="ml-4">
                    <p class="text-gray-500">คะแนนเฉลี่ย</p>
                    <p id="average-score" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>
            <!-- Total Characters -->
            <div class="kpi-card characters flex items-center">
                 <div class="bg-green-100 p-4 rounded-full">
                    <svg class="h-8 w-8 text-green-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>
                <div class="ml-4">
                    <p class="text-gray-500">ตัวละครทั้งหมด</p>
                    <p id="total-characters" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>
            <!-- Total Classes -->
            <div class="kpi-card classes flex items-center">
                 <div class="bg-purple-100 p-4 rounded-full">
                    <svg class="h-8 w-8 text-purple-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                </div>
                <div class="ml-4">
                    <p class="text-gray-500">จำนวนห้องเรียน</p>
                    <p id="total-classes" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
             <!-- Leaderboard -->
            <div class="chart-container lg:col-span-1">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ตารางอันดับนักเรียน (Top 5)</h2>
                <div id="leaderboard" class="space-y-4">
                    <!-- Leaderboard items will be injected here -->
                </div>
            </div>

            <!-- Class Average Score -->
            <div class="chart-container lg:col-span-2 flex flex-col">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex-shrink-0">คะแนนเฉลี่ยตามระดับชั้น</h2>
                <div class="relative flex-grow">
                    <canvas id="classAverageScoreChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
             <!-- Character Distribution -->
            <div class="chart-container lg:col-span-1 flex flex-col">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex-shrink-0">สัดส่วนตัวละคร</h2>
                <div class="relative flex-grow flex items-center justify-center">
                    <canvas id="characterDistributionChart" class="max-h-80"></canvas>
                </div>
            </div>
            <!-- Score Distribution -->
            <div class="chart-container lg:col-span-2 flex flex-col">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex-shrink-0">การกระจายของคะแนน</h2>
                <div class="relative flex-grow">
                    <canvas id="scoreDistributionChart"></canvas>
                </div>
            </div>
        </div>
        
        <footer class="text-center py-8 text-gray-500 text-sm">
            <p>&copy; 2025 Student Score Dashboard. All rights reserved.</p>
            <p>จัดทำสำหรับ P23 WSN 25680702</p>
        </footer>

    </div>

    <script>
        // Global variables
        let allProcessedData = [];
        const activeCharts = {};

        // Function to destroy a chart instance if it exists
        function destroyChart(chartId) {
            if (activeCharts[chartId]) {
                activeCharts[chartId].destroy();
                delete activeCharts[chartId];
            }
        }

        function updateKpiCards(data) {
            const totalStudents = new Set(data.map(d => d['ชื่อ'])).size;
            document.getElementById('total-students').textContent = totalStudents;

            const totalScore = data.reduce((acc, curr) => acc + curr['คะแนน'], 0);
            const averageScore = totalStudents > 0 ? (totalScore / totalStudents).toFixed(2) : 0;
            document.getElementById('average-score').textContent = averageScore;

            const totalCharacters = new Set(data.map(d => d['ตัวละคร'])).size;
            document.getElementById('total-characters').textContent = totalCharacters;
            
            // This KPI should always show the total number of classes from all data
            const totalClasses = new Set(allProcessedData.map(d => d['ระดับชั้น'])).size;
            document.getElementById('total-classes').textContent = totalClasses;
        }
        
        function updateLeaderboard(data) {
            const leaderboardContainer = document.getElementById('leaderboard');
            leaderboardContainer.innerHTML = ''; // Clear existing leaderboard
            const sortedStudents = [...data].sort((a, b) => b['คะแนน'] - a['คะแนน']);
            const top5 = sortedStudents.slice(0, 5);
            const rankColors = ['#ffd700', '#c0c0c0', '#cd7f32', '#a0aec0', '#a0aec0'];

            if(top5.length === 0){
                leaderboardContainer.innerHTML = `<p class="text-gray-500 text-center">ไม่มีข้อมูลสำหรับแสดงผล</p>`;
                return;
            }

            top5.forEach((student, index) => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex items-center p-3 rounded-lg hover:bg-gray-50';
                studentDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-white" style="background-color: ${rankColors[index] || '#cbd5e1'};">
                       ${index + 1}
                    </div>
                    <img src="${student['ภาพตัวละคร']}" alt="${student['ตัวละคร']}" class="w-12 h-12 rounded-full ml-4 object-cover border-2 border-white shadow-md" onerror="this.src='https://placehold.co/48x48/e2e8f0/64748b?text=?'; this.onerror=null;">
                    <div class="ml-4 flex-grow">
                        <p class="font-semibold text-gray-800">${student['ชื่อ']}</p>
                        <p class="text-sm text-gray-500">${student['ตัวละคร']} - ${student['ระดับชั้น']}</p>
                    </div>
                    <div class="font-bold text-lg text-blue-600">${student['คะแนน']}</div>
                `;
                leaderboardContainer.appendChild(studentDiv);
            });
        }

        function createClassAverageScoreChart(data) {
            destroyChart('classAverageScoreChart');
            const scoresByClass = d3.group(data, d => d['ระดับชั้น']);
            const classAverageScores = Array.from(scoresByClass, ([key, values]) => {
                const total = d3.sum(values, d => d['คะแนน']);
                return {
                    class: key,
                    average: total / values.length
                };
            }).sort((a,b) => b.average - a.average);

            const chart = new Chart(document.getElementById('classAverageScoreChart'), {
                type: 'bar',
                data: {
                    labels: classAverageScores.map(d => d.class),
                    datasets: [{
                        label: 'คะแนนเฉลี่ย',
                        data: classAverageScores.map(d => d.average),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { color: '#e5e7eb' } },
                        y: { grid: { display: false } }
                    }
                }
            });
            activeCharts['classAverageScoreChart'] = chart;
        }

        function updateCharacterDistributionChart(data) {
            destroyChart('characterDistributionChart');
            const characterCounts = d3.rollup(data, v => v.length, d => d['ตัวละคร']);
            const sortedCharacters = Array.from(characterCounts.entries()).sort((a, b) => b[1] - a[1]);
            
            if(sortedCharacters.length === 0) return;

            const chart = new Chart(document.getElementById('characterDistributionChart'), {
                type: 'doughnut',
                data: {
                    labels: sortedCharacters.map(d => d[0]),
                    datasets: [{
                        label: 'จำนวนนักเรียน',
                        data: sortedCharacters.map(d => d[1]),
                        backgroundColor: ['#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#f97316', '#ec4899', '#6366f1'],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12 } } }
                }
            });
            activeCharts['characterDistributionChart'] = chart;
        }

        function updateScoreDistributionChart(data) {
            destroyChart('scoreDistributionChart');
            if(data.length === 0) return;

            const scoreBins = d3.bin().thresholds(10)(data.map(d => d['คะแนน']));
            const chart = new Chart(document.getElementById('scoreDistributionChart'), {
                type: 'bar',
                data: {
                    labels: scoreBins.map(bin => `${bin.x0}-${bin.x1}`),
                    datasets: [{
                        label: 'จำนวนนักเรียน',
                        data: scoreBins.map(bin => bin.length),
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'จำนวนนักเรียน' }, grid: { color: '#e5e7eb' } },
                        x: { title: { display: true, text: 'ช่วงคะแนน' }, grid: { display: false } }
                    }
                }
            });
            activeCharts['scoreDistributionChart'] = chart;
        }

        // Main function to update dashboard based on filter
        function updateDashboard(selectedClass = 'All') {
            const filteredData = (selectedClass === 'All')
                ? allProcessedData
                : allProcessedData.filter(d => d['ระดับชั้น'] === selectedClass);

            updateKpiCards(filteredData);
            updateLeaderboard(filteredData);
            updateCharacterDistributionChart(filteredData);
            updateScoreDistributionChart(filteredData);

            // Update active state of buttons
            document.querySelectorAll('#class-filter-nav button').forEach(button => {
                if (button.dataset.class === selectedClass) {
                    button.classList.add('bg-blue-600', 'text-white');
                    button.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    button.classList.remove('bg-blue-600', 'text-white');
                    button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const dataFiles = ['P32.csv', 'P31.csv', 'P33.csv'];

            try {
                const allDataPromises = dataFiles.map(file => d3.csv(file));
                const allDataArrays = await Promise.all(allDataPromises);

                const data = [].concat(...allDataArrays);

                allProcessedData = data.map(d => {
                    const score = parseInt(d['คะแนน'], 10);
                    return {
                        ...d,
                        'ชื่อ': d['ชื่อ - สกุล']?.trim(),
                        'คะแนน': isNaN(score) ? 0 : score,
                        'ระดับชั้น': d['ระดับชั้น']?.trim()
                    };
                }).filter(d => d['ชื่อ'] && d['ระดับชั้น']);

                // Populate Navbar
                const classes = ['All', ...new Set(allProcessedData.map(d => d['ระดับชั้น']).filter(Boolean).sort())];
                const navContainer = document.getElementById('class-filter-nav');
                classes.forEach(className => {
                    const button = document.createElement('button');
                    button.textContent = className === 'All' ? 'ทุกห้อง' : className;
                    button.dataset.class = className;
                    button.className = 'px-4 py-2 rounded-md font-semibold transition-colors duration-200 text-sm';
                    button.addEventListener('click', () => updateDashboard(className));
                    navContainer.appendChild(button);
                });

                // Initial render
                createClassAverageScoreChart(allProcessedData);
                updateDashboard('All');


            } catch (error) {
                console.error('Error loading or processing data:', error);
                document.getElementById('loading').innerHTML = `<div class="text-center text-red-600"><p class="text-2xl font-bold">เกิดข้อผิดพลาด</p><p>ไม่สามารถโหลดไฟล์ข้อมูลได้ กรุณาตรวจสอบว่าไฟล์ทั้งหมด (${dataFiles.join(', ')}) ถูกต้องและอยู่ในตำแหน่งเดียวกัน</p><p class="text-sm mt-2">${error.message}</p></div>`;
            } finally {
                setTimeout(() => {
                    const loadingElement = document.getElementById('loading');
                    loadingElement.style.transition = 'opacity 0.5s ease';
                    loadingElement.style.opacity = '0';
                    setTimeout(() => loadingElement.style.display = 'none', 500);
                }, 500);
            }
        });
    </script>
</body>
</html>

